# Control System for NEMA 17 Stepper Motor with TB6560 Driver and HC-SR04 Ultrasonic Sensor
## Table of Contents

1. [Project Overview](#project-overview)
2. [Features](#features)
3. [Hardware Components](#hardware-components)
4. [Software Components](#software-components)
5. [Installation](#installation)
    - [Prerequisites](#prerequisites)
    - [Hardware Setup](#hardware-setup)
    - [Arduino Code Setup](#arduino-code-setup)
    - [Python Environment Setup](#python-environment-setup)
6. [Usage](#usage)
    - [Uploading Code to Arduino](#uploading-code-to-arduino)
    - [Running the Python GUI](#running-the-python-gui)
    - [Interacting with the System](#interacting-with-the-system)
7. [Configuration](#configuration)
    - [Arduino Configuration](#arduino-configuration)
    - [Python Configuration](#python-configuration)
8. [Logging and Debugging](#logging-and-debugging)
9. [Troubleshooting](#troubleshooting)
10. [Contributing](#contributing)
11. [License](#license)
12. [Acknowledgments](#acknowledgments)
13. [Contact](#contact)

---

## Project Overview

This project implements a comprehensive control system for a **NEMA 17 Stepper Motor** using an **TB6560 Driver** and an **HC-SR04 Ultrasonic Sensor**. The system facilitates both automatic and manual control modes, allowing precise motor movements based on real-time distance measurements. A **Python-based Graphical User Interface (GUI)** provides an intuitive platform for users to interact with the system, monitor sensor data, and issue control commands seamlessly.

**Key Objectives:**

- Automate motor movements between predefined positions using sensor feedback.
- Enable manual control of motor direction and speed via a user-friendly GUI.
- Implement robust error handling and logging mechanisms for reliable operation.
- Maintain a modular and scalable codebase for easy maintenance and future enhancements.

## Features

- **Automatic Mode**: Motor moves downward until a distance of 7 cm is detected, then moves upward until a distance of 35 cm is reached, repeating this cycle indefinitely.
- **Manual Mode**: Users can manually command the motor to move up, down, or stop via the Python GUI or serial commands.
- **Real-Time Monitoring**: Live distance measurements are displayed on the GUI using visual gauges.
- **Adjustable Motor Speed**: Users can modify the motor's speed dynamically through the GUI.
- **Error Handling**: The system gracefully handles sensor read failures and communication issues.
- **Logging System**: Comprehensive logging for both Arduino and Python components to facilitate debugging and monitoring.
- **Modular Architecture**: Well-organized codebase with separate modules for motor control, sensor management, system logic, and GUI operations.
- **Extensible Design**: Easy integration of additional sensors, actuators, or features in the future.

## Hardware Components

1. **Arduino Board**: [Arduino Uno](https://store.arduino.cc/products/arduino-uno-rev3) (or compatible)
2. **Stepper Motor**: [NEMA 17 Stepper Motor](https://www.adafruit.com/product/1688)
3. **Stepper Motor Driver**: [TB6560 Driver](https://www.amazon.com/dp/B07F7V5MQT) (compatible)
4. **Ultrasonic Sensor**: [HC-SR04](https://www.sparkfun.com/products/15569)
5. **Power Supply**: Suitable for TB6560 and stepper motor (e.g., 12V DC, 2A)
6. **Connecting Wires and Breadboard**
7. **Optional Components**:
    - **Current Sensor**: [ACS712](https://www.sparkfun.com/products/3013) for overcurrent protection
    - **Resistors, Capacitors**: As required by your specific setup

## Software Components

1. **Arduino IDE**: For writing, compiling, and uploading Arduino code.
2. **Visual Studio Code (VSCode)**: Integrated development environment with extensions for Arduino and Python.
3. **Python 3.6+**: Programming language for the GUI and serial communication.
4. **Python Libraries**:
    - `pyserial`: For serial communication.
    - `matplotlib`: For data visualization.
    - `Tkinter` or `PyQt`: For building the GUI.
    - `logging`: For logging system events.
    - Other dependencies as specified in `requirements.txt`.

## File Structure


### Description of Key Files and Folders

- **`.vscode/`**: Configuration files for VSCode, including settings for Arduino and debugging.
- **`gui/`**: Contains all Python scripts related to the GUI, serial communication, logging, and visualization.
    - **`serial_comm.py`**: Handles serial communication between Python and Arduino.
    - **`matplotlib_gauge.py`**: Responsible for visualizing sensor data using gauges.
    - **`gui.py`**: Main GUI application script.
    - **`styles.py`**: Defines styles and themes for the GUI.
    - **`logs/`**: Stores log files generated by the GUI.
- **`lineal_actuator/`**: Contains Arduino code modules.
    - **`Config.h`**: Centralized configuration file with constants and settings.
    - **`Motor.h` & `Motor.cpp`**: Module for motor control functionalities.
    - **`Sensor.h` & `Sensor.cpp`**: Module for ultrasonic sensor management.
    - **`Logic.h` & `Logic.cpp`**: Module containing system logic and state management.
    - **`lineal_actuator.ino`**: Main Arduino sketch that integrates all modules.
- **`logging_config.py`**: Python script configuring the logging system.
- **`logs/`**: Contains global log files.
- **`motor_control_gui.py` & `run_gui.py`**: Scripts to initialize and run the GUI application.
- **`__pycache__/`**: Compiled Python bytecode for faster execution.

## Installation

### Prerequisites

- **Arduino IDE**: Download and install from [Arduino Official Site](https://www.arduino.cc/en/software).
- **Visual Studio Code (VSCode)**: Download and install from [VSCode Official Site](https://code.visualstudio.com/).
- **Python 3.6+**: Download and install from [Python Official Site](https://www.python.org/downloads/).
- **Python Libraries**: Install required libraries using `pip`.
    ```bash
    pip install -r requirements.txt
    ```
    *(Create a `requirements.txt` file if not already present with the necessary dependencies)*

### Hardware Setup

1. **Connect the NEMA 17 Stepper Motor to TB6560 Driver**:
    - **Motor Wires**: Connect the motor wires to the TB6560 driver according to the motor's datasheet.
    - **Power Supply**: Connect an appropriate power supply to the TB6560 driver (e.g., 12V DC, 2A).
    - **Control Pins**: Connect the driver’s control pins (Pulse and Direction) to the Arduino.
        - **Pulse Pin**: Connect to Arduino Digital Pin 3.
        - **Direction Pin**: Connect to Arduino Digital Pin 4.

2. **Connect HC-SR04 Ultrasonic Sensor to Arduino**:
    - **VCC**: Connect to 5V on Arduino.
    - **GND**: Connect to GND on Arduino.
    - **Trig**: Connect to Digital Pin 9 on Arduino.
    - **Echo**: Connect to Digital Pin 10 on Arduino.

3. **Optional: Connect Current Sensor for Overcurrent Protection**:
    - **VCC**: Connect to 5V on Arduino.
    - **GND**: Connect to GND on Arduino.
    - **OUT**: Connect to an Analog Pin on Arduino (e.g., A0).

4. **Finalize Connections**:
    - Ensure all connections are secure.
    - Double-check pin assignments against `Config.h`.

### Arduino Code Setup

1. **Open the Project in VSCode**:
    - Launch VSCode.
    - Open the `control_system/` folder.

2. **Configure VSCode for Arduino**:
    - Ensure the Arduino extension is installed.
    - Open `.vscode/arduino.json` and verify the following:
        - `"sketch"` points to `lineal_actuator/lineal_actuator.ino`.
        - `"board"` is set to your Arduino model (e.g., `"arduino:avr:uno"`).
        - `"port"` matches the port your Arduino is connected to (e.g., `"COM3"` on Windows or `"/dev/ttyACM0"` on Linux).

3. **Configure `c_cpp_properties.json`**:
    - Ensure the `includePath` includes `"${workspaceFolder}/**"` to allow VSCode to find all header files.
    - Example configuration:
        ```json
        {
            "configurations": [
                {
                    "name": "Arduino",
                    "includePath": [
                        "${workspaceFolder}/**",
                        "${env:ARDUINO_HOME}/libraries/**"
                    ],
                    "defines": [
                        "USBCON"
                    ],
                    "compilerPath": "/usr/bin/avr-gcc",
                    "cStandard": "c11",
                    "cppStandard": "c++17",
                    "intelliSenseMode": "gcc-x64"
                }
            ],
            "version": 4
        }
        ```

4. **Verify the Code**:
    - Click the `Verify` (✓) button in the Arduino toolbar within VSCode.
    - Ensure there are no compilation errors.

5. **Upload the Code to Arduino**:
    - Click the `Upload` (→) button in the Arduino toolbar.
    - Wait for the upload to complete successfully.

### Python Environment Setup

1. **Navigate to the Project Directory**:
    ```bash
    cd path/to/control_system/
    ```

2. **Create a Virtual Environment (Optional but Recommended)**:
    ```bash
    python -m venv venv
    source venv/bin/activate  # On Windows: venv\Scripts\activate
    ```

3. **Install Required Python Libraries**:
    ```bash
    pip install -r requirements.txt
    ```
    *(Ensure that all necessary libraries are listed in `requirements.txt`)*

4. **Configure `serial_comm.py`**:
    - Open `gui/serial_comm.py`.
    - Set the correct serial port (e.g., `COM3` for Windows or `/dev/ttyACM0` for Linux).

    ```python
    # Example
    serial_port = 'COM3'  # Replace with your Arduino's serial port
    ```

## Usage

### Uploading Code to Arduino

1. **Connect Arduino to PC**:
    - Use a USB cable to connect your Arduino board to your computer.

2. **Open VSCode and Project**:
    - Launch VSCode.
    - Open the `control_system/` folder.

3. **Verify and Upload**:
    - Click `Verify` to compile the code.
    - Click `Upload` to send the code to the Arduino.
    - Monitor the output for any errors.

4. **Monitor Serial Output (Optional)**:
    - Open the Serial Monitor in VSCode or use an external tool like `PuTTY` or `minicom` to view Arduino logs.
    - Ensure the baud rate is set to `9600`.

### Running the Python GUI

1. **Ensure Arduino is Connected and Code is Uploaded**:
    - The Arduino should be running the `lineal_actuator.ino` sketch.

2. **Open Terminal in VSCode**:
    - Navigate to the `control_system/` directory.

3. **Activate Virtual Environment (If Created)**:
    ```bash
    source venv/bin/activate  # On Windows: venv\Scripts\activate
    ```

4. **Run the GUI Application**:
    ```bash
    python run_gui.py
    ```
    - Alternatively, if `motor_control_gui.py` is the main GUI script, run:
    ```bash
    python motor_control_gui.py
    ```

5. **Interact with the GUI**:
    - Use the provided buttons and controls to send commands to the Arduino.
    - Monitor real-time data and logs within the GUI.

### Interacting with the System

- **Automatic Mode**:
    - Activate via GUI button or send the `AUTO` command.
    - Motor moves between 7 cm and 35 cm based on sensor readings.

- **Manual Control**:
    - Use GUI buttons or send `UP`, `DOWN`, `STOP` commands to control motor direction.

- **Adjusting Motor Speed**:
    - Send `SET_SPEED <value_in_microseconds>` command via GUI or Python scripts to adjust the pulse interval, thus controlling motor speed.

- **Monitoring Logs**:
    - View real-time logs within the GUI or check `logs/app.log` for detailed logs.

## Configuration

### Arduino Configuration

All configurable parameters are centralized in the `Config.h` file within the `lineal_actuator/` directory. Adjust the following as needed:

- **Pin Definitions**:
    ```cpp
    // Pines del Motor Paso a Paso con TB6560
    const uint8_t MOTOR_PUL_PIN = 3;        // Pin para el pulso
    const uint8_t MOTOR_DIR_PIN = 4;        // Pin para la dirección

    // Pines del Sensor Ultrasónico HC-SR04
    const uint8_t SENSOR_TRIG_PIN = 9;      // Pin de Trigger
    const uint8_t SENSOR_ECHO_PIN = 10;     // Pin de Echo
    ```

- **System Parameters**:
    ```cpp
    // Distancias objetivo (en centímetros)
    const float DISTANCE_LOWER_TARGET = 7.0;     // Distancia para detenerse al bajar
    const float DISTANCE_UPPER_TARGET = 35.0;    // Distancia para detenerse al subir
    const float DISTANCE_MARGIN = 0.5;           // Margen para evitar oscilaciones

    // Velocidad del Motor
    const unsigned long PULSE_INTERVAL_DEFAULT_US = 800; // Intervalo entre pulsos en micros (ajustar para la velocidad)
    unsigned long pulseInterval = PULSE_INTERVAL_DEFAULT_US;

    // Intervalo de lectura del sensor ultrasónico
    const unsigned long SENSOR_READ_INTERVAL_MS = 100; // Intervalo entre mediciones en milisegundos

    // Timeout para la lectura del sensor ultrasónico
    const unsigned long ULTRASONIC_TIMEOUT_US = 30000; // Timeout en micros (30 ms)
    ```

- **Logging Configuration**:
    ```cpp
    #define LOG_VERBOSITY 2 // 0: Off, 1: Error, 2: Info, 3: Debug

    #if LOG_VERBOSITY >= 1
      #define LOG_ERROR(msg) Serial.println(F(msg))
    #else
      #define LOG_ERROR(msg)
    #endif

    #if LOG_VERBOSITY >= 2
      #define LOG_INFO(msg) Serial.println(F(msg))
    #else
      #define LOG_INFO(msg)
    #endif

    #if LOG_VERBOSITY >= 3
      #define LOG_DEBUG(msg) Serial.println(F(msg))
    #else
      #define LOG_DEBUG(msg)
    #endif
    ```

### Python Configuration

Configuration settings for the Python GUI and serial communication are managed within the Python scripts, primarily in `serial_comm.py` and `run_gui.py`.

- **Serial Port Configuration**:
    - Edit `serial_comm.py` to specify the correct serial port.
    ```python
    # serial_comm.py

    serial_port = 'COM3'  # Replace with your Arduino's serial port (e.g., 'COM3' on Windows or '/dev/ttyACM0' on Linux)
    baudrate = 9600
    timeout = 1
    ```

- **Logging Configuration**:
    - Adjust logging levels and log file paths in `logging_config.py`.
    ```python
    # logging_config.py

    import logging

    logging.basicConfig(
        filename='logs/app.log',
        level=logging.DEBUG,  # Adjust as needed: DEBUG, INFO, WARNING, ERROR, CRITICAL
        format='%(asctime)s - %(levelname)s - %(message)s'
    )
    ```

- **GUI Customization**:
    - Modify `styles.py` to change the appearance of the GUI.
    - Update `matplotlib_gauge.py` for different gauge styles or additional visualizations.

## Logging and Debugging

### Arduino Logging

- **Logging Levels**:
    - **ERROR**: Critical issues that need immediate attention.
    - **INFO**: General information about system operations.
    - **DEBUG**: Detailed debugging information for development purposes.

- **Adjusting Verbosity**:
    - Set `LOG_VERBOSITY` in `Config.h` to control the level of logging:
        ```cpp
        #define LOG_VERBOSITY 2 // 0: Off, 1: Error, 2: Info, 3: Debug
        ```

- **Viewing Logs**:
    - Use the Serial Monitor in Arduino IDE or VSCode to view real-time logs.
    - Ensure the baud rate is set to `9600`.

### Python Logging

- **Logging Configuration**:
    - Configured in `logging_config.py` using Python's `logging` module.
    - Logs are stored in `logs/app.log`.

- **Log Levels**:
    - **DEBUG**: Detailed information, typically of interest only when diagnosing problems.
    - **INFO**: Confirmation that things are working as expected.
    - **WARNING**: An indication that something unexpected happened, or indicative of some problem in the near future.
    - **ERROR**: Due to a more serious problem, the software has not been able to perform some function.
    - **CRITICAL**: A very serious error, indicating that the program itself may be unable to continue running.

- **Viewing Logs**:
    - Open `logs/app.log` to review historical logs.
    - Logs are also output to the console during runtime.

## Troubleshooting

### Common Issues and Solutions

1. **Arduino Compilation Errors**:
    - **Cause**: Missing or incorrectly placed header/source files.
    - **Solution**: Ensure all modules (`Motor.h`, `Motor.cpp`, `Sensor.h`, `Sensor.cpp`, `Logic.h`, `Logic.cpp`) are correctly placed in the `lineal_actuator/` directory and properly included in `lineal_actuator.ino`.

2. **Serial Communication Issues**:
    - **Cause**: Incorrect serial port or baud rate settings.
    - **Solution**: Verify that `serial_comm.py` points to the correct serial port and matches the baud rate set in `lineal_actuator.ino`.

3. **GUI Not Responding or Crashing**:
    - **Cause**: Unhandled exceptions or incorrect GUI configurations.
    - **Solution**: Check `logs/app.log` for error messages. Ensure all required Python libraries are installed and up-to-date.

4. **Motor Not Moving**:
    - **Cause**: Incorrect wiring, insufficient power, or code issues.
    - **Solution**: Double-check all hardware connections, ensure the power supply is adequate, and verify motor control logic in Arduino code.

5. **Ultrasonic Sensor Not Reading Correctly**:
    - **Cause**: Incorrect sensor placement, wiring issues, or environmental factors.
    - **Solution**: Ensure the sensor is properly connected and mounted. Test the sensor independently using a simple Arduino sketch to verify functionality.

6. **Overcurrent Protection Not Triggering**:
    - **Cause**: Faulty current sensor or incorrect integration.
    - **Solution**: Verify the current sensor connections and functionality. Ensure the current thresholds are correctly set in the Arduino code.

### Debugging Steps

1. **Isolate Components**:
    - Test the motor and driver with a simple stepper motor sketch.
    - Test the ultrasonic sensor with a standalone distance measurement sketch.

2. **Use Serial Logs**:
    - Utilize Arduino's Serial Monitor to view real-time logs and identify where the system may be failing.

3. **Check Power Supply**:
    - Ensure the power supply can handle the motor's current requirements. Use a multimeter to verify voltage levels.

4. **Review Wiring**:
    - Double-check all connections against the `Config.h` pin definitions.

5. **Update Firmware and Libraries**:
    - Ensure the Arduino IDE and all libraries are up-to-date.

## Contributing

Contributions are welcome! Whether it's reporting bugs, suggesting features, or submitting pull requests, your input helps improve the project.

### How to Contribute

1. **Fork the Repository**: Click the "Fork" button on the repository page.
2. **Clone Your Fork**:
    ```bash
    git clone https://github.com/your-username/control_system.git
    ```
3. **Create a New Branch**:
    ```bash
    git checkout -b feature/your-feature-name
    ```
4. **Make Your Changes**: Implement your feature or fix.
5. **Commit Your Changes**:
    ```bash
    git commit -m "Add feature: your feature description"
    ```
6. **Push to Your Fork**:
    ```bash
    git push origin feature/your-feature-name
    ```
7. **Create a Pull Request**: Navigate to the original repository and submit a pull request with a detailed description of your changes.

### Code of Conduct

Please adhere to the [Code of Conduct](CODE_OF_CONDUCT.md) when contributing to this project.

## License

This project is licensed under the [MIT License](LICENSE).

## Acknowledgments

- **Arduino Community**: For providing comprehensive resources and support.
- **OpenAI**: For assistance in code structuring and documentation.
- **Python Developers**: For creating powerful libraries that facilitate GUI development and serial communication.
- **Manufacturers of Hardware Components**: Providing reliable and high-quality components essential for the project.
- **VSCode Extensions**: For enhancing the development experience with powerful tools for Arduino and Python.

---

*This project is a work in progress. Contributions and feedback are highly appreciated to improve its functionality and robustness.*
